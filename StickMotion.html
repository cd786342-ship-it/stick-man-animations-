<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>StickMotion</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#070710;font-family:'Courier New',monospace;color:#e0fff8;overflow:hidden}
  input:focus{outline:none}
  input[type=range]{accent-color:#00ffc8;width:100%}
  ::-webkit-scrollbar{width:4px}
  ::-webkit-scrollbar-track{background:#0a0a1a}
  ::-webkit-scrollbar-thumb{background:#00ffc830;border-radius:2px}

  /* AUTH */
  #auth{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0a0a0f;z-index:100}
  #auth-box{position:relative;z-index:10;background:rgba(10,10,20,0.93);border:1px solid #00ffc855;border-radius:16px;padding:36px 44px;width:400px;box-shadow:0 0 60px #00ffc820,0 0 120px #00ffc810}
  #bg-canvas{position:fixed;inset:0;opacity:.5;pointer-events:none}
  .auth-tabs{display:flex;margin-bottom:24px;border-bottom:1px solid #ffffff15}
  .auth-tab{flex:1;padding:10px 0;background:none;border:none;border-bottom:2px solid transparent;color:#ffffff44;font-family:inherit;font-size:12px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;transition:all .2s}
  .auth-tab.active{border-bottom-color:#00ffc8;color:#00ffc8}
  .field{margin-bottom:14px}
  .field label{display:block;color:#ffffff66;font-size:10px;letter-spacing:2px;margin-bottom:5px;text-transform:uppercase}
  .field input{width:100%;background:#ffffff08;border:1px solid #00ffc830;border-radius:8px;padding:11px 13px;color:#e0fff8;font-family:inherit;font-size:13px;transition:border-color .2s}
  .field input:focus{border-color:#00ffc8}
  .err{color:#ff6b6b;font-size:11px;text-align:center;margin-bottom:10px}
  .btn-primary{width:100%;padding:13px 0;margin-top:6px;background:linear-gradient(135deg,#00ffc8,#00b8ff);border:none;border-radius:8px;color:#0a0a1a;font-family:inherit;font-size:13px;font-weight:bold;letter-spacing:2px;text-transform:uppercase;cursor:pointer;box-shadow:0 4px 24px #00ffc840;transition:opacity .2s}
  .btn-primary:hover{opacity:.85}

  /* APP */
  #app{display:none;height:100vh;flex-direction:column}
  #app.show{display:flex}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 22px;border-bottom:1px solid #00ffc820;background:rgba(0,255,200,0.03);flex-shrink:0}
  .header-nav{display:flex;gap:4px;align-items:center}
  .nav-btn{padding:7px 16px;background:none;border:1px solid transparent;border-radius:6px;color:#ffffff44;font-family:inherit;font-size:10px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;transition:all .2s}
  .nav-btn.active{background:#00ffc815;border-color:#00ffc840;color:#00ffc8}
  .nav-btn.logout{border-color:#ff6b6b30;color:#ff6b6b88}
  .nav-btn.logout:hover{background:#ff6b6b10}

  /* EDITOR LAYOUT */
  #editor{display:flex;flex:1;overflow:hidden}
  #frame-list{width:108px;border-right:1px solid #00ffc815;overflow-y:auto;padding:10px 8px;background:#050510;display:flex;flex-direction:column;gap:7px}
  #frame-list .fl-label{font-size:9px;color:#ffffff33;letter-spacing:2px;text-align:center;margin-bottom:2px}
  .frame-thumb{cursor:pointer;text-align:center}
  .frame-thumb canvas{border-radius:5px;border:1px solid #ffffff15;background:#0a0a1a;display:block}
  .frame-thumb.active canvas{border-color:#00ffc8;background:#00ffc808}
  .frame-thumb span{font-size:8px;color:#ffffff33;letter-spacing:1px}
  .frame-thumb.active span{color:#00ffc8}

  #canvas-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:18px;overflow:hidden}
  .canvas-top{display:flex;align-items:center;gap:10px;width:100%;max-width:500px}
  .canvas-top input{flex:1;background:#ffffff08;border:1px solid #00ffc820;border-radius:6px;padding:7px 12px;color:#e0fff8;font-family:inherit;font-size:12px}
  .canvas-top input:focus{border-color:#00ffc8;outline:none}
  .save-btn{padding:7px 18px;background:#00ffc810;border:1px solid #00ffc830;border-radius:6px;color:#00ffc888;font-family:inherit;font-size:10px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;transition:all .2s;white-space:nowrap}
  .save-btn.saved{background:#00ffc820;border-color:#00ffc8;color:#00ffc8}
  #main-canvas{border-radius:10px;border:1px solid #00ffc820;background:#0a0a1a;box-shadow:0 0 40px #00ffc810;cursor:crosshair;touch-action:none;max-width:100%;max-height:calc(100vh - 260px)}
  .frame-controls{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
  .frame-btn{padding:7px 14px;background:#ffffff08;border:1px solid #ffffff15;border-radius:6px;color:#ffffffaa;font-family:inherit;font-size:10px;letter-spacing:1px;cursor:pointer;text-transform:uppercase}
  .frame-btn:hover{background:#ffffff14;color:#fff}
  .hint{font-size:10px;color:#ffffff33}

  #side-panel{width:250px;border-left:1px solid #00ffc815;background:#050510;padding:16px;display:flex;flex-direction:column;gap:14px;overflow-y:auto}
  .sp-label{font-size:9px;color:#ffffff33;letter-spacing:2px;text-align:center}
  #preview-canvas{border-radius:8px;border:1px solid #00ffc820;background:#0a0a1a;width:100%}
  .play-btn{padding:11px 0;width:100%;background:linear-gradient(135deg,#00ffc820,#00b8ff20);border:1px solid #00ffc840;border-radius:8px;color:#00ffc8;font-family:inherit;font-size:13px;letter-spacing:3px;cursor:pointer;transition:all .2s}
  .play-btn.stop{background:#ff6b6b15;border-color:#ff6b6b40;color:#ff9999}
  .sp-divider{border-top:1px solid #ffffff10;padding-top:10px}
  .pose-btn{display:block;width:100%;margin-bottom:5px;padding:7px 10px;text-align:left;background:#ffffff05;border:1px solid #ffffff10;border-radius:6px;color:#ffffffaa;font-family:inherit;font-size:11px;cursor:pointer}
  .pose-btn:hover{background:#00ffc810;border-color:#00ffc840;color:#00ffc8}

  /* LIBRARY */
  #library{display:none;padding:28px;overflow-y:auto;flex:1}
  #library.show{display:block}
  #library h2{color:#00ffc8;letter-spacing:4px;margin-bottom:20px;font-size:15px;text-transform:uppercase}
  .lib-empty{display:flex;align-items:center;justify-content:center;height:50vh;flex-direction:column;gap:10px}
  .lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px}
  .lib-card{background:#0a0a1a;border:1px solid #00ffc820;border-radius:10px;padding:14px;transition:border-color .2s}
  .lib-card:hover{border-color:#00ffc850}
  .lib-card-name{color:#00ffc8;font-size:12px;font-weight:bold;letter-spacing:1px;margin-bottom:3px}
  .lib-card-meta{color:#ffffff33;font-size:9px;margin-bottom:10px}
  .lib-card-actions{display:flex;gap:7px}
  .lib-open{flex:1;padding:7px 0;background:#00ffc815;border:1px solid #00ffc840;border-radius:5px;color:#00ffc8;font-family:inherit;font-size:9px;cursor:pointer;letter-spacing:1px;text-transform:uppercase}
  .lib-del{padding:7px 10px;background:#ff6b6b10;border:1px solid #ff6b6b30;border-radius:5px;color:#ff9999;font-family:inherit;font-size:9px;cursor:pointer}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth">
  <canvas id="bg-canvas"></canvas>
  <div id="auth-box">
    <!-- Logo -->
    <div style="display:flex;justify-content:center;margin-bottom:24px">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 520 180" width="290">
        <defs>
          <linearGradient id="tg" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#00ffc8"/><stop offset="50%" stop-color="#00d4ff"/><stop offset="100%" stop-color="#7b61ff"/>
          </linearGradient>
          <filter id="gl" x="-40%" y="-40%" width="180%" height="180%"><feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <filter id="gls" x="-60%" y="-60%" width="220%" height="220%"><feGaussianBlur stdDeviation="7" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <filter id="glm" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <linearGradient id="tr" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#00ffc8" stop-opacity="0"/><stop offset="100%" stop-color="#00ffc8" stop-opacity="0.5"/></linearGradient>
        </defs>
        <g opacity="0.2"><line x1="10" y1="58" x2="90" y2="58" stroke="url(#tr)" stroke-width="1.5"/><line x1="30" y1="100" x2="88" y2="100" stroke="url(#tr)" stroke-width="1.5"/><line x1="5" y1="145" x2="88" y2="142" stroke="url(#tr)" stroke-width="1.5"/></g>
        <g opacity="0.08" filter="url(#glm)" transform="translate(-18,0)">
          <circle cx="90" cy="45" r="14" stroke="#00ffc8" stroke-width="2.5" fill="none"/>
          <line x1="90" y1="59" x2="90" y2="105" stroke="#00ffc8" stroke-width="2.5" stroke-linecap="round"/>
          <line x1="90" y1="72" x2="68" y2="92" stroke="#00ffc8" stroke-width="2.5" stroke-linecap="round"/>
          <line x1="90" y1="72" x2="112" y2="88" stroke="#00ffc8" stroke-width="2.5" stroke-linecap="round"/>
          <line x1="90" y1="105" x2="75" y2="135" stroke="#00ffc8" stroke-width="2.5" stroke-linecap="round"/>
          <line x1="75" y1="135" x2="62" y2="155" stroke="#00ffc8" stroke-width="2.5" stroke-linecap="round"/>
          <line x1="90" y1="105" x2="108" y2="128" stroke="#00ffc8" stroke-width="2.5" stroke-linecap="round"/>
          <line x1="108" y1="128" x2="118" y2="155" stroke="#00ffc8" stroke-width="2.5" stroke-linecap="round"/>
        </g>
        <g filter="url(#gls)">
          <circle cx="90" cy="45" r="14" stroke="#00ffc8" stroke-width="3" fill="none"/>
          <line x1="90" y1="59" x2="88" y2="105" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="90" y1="72" x2="108" y2="88" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="108" y1="88" x2="126" y2="72" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="90" y1="72" x2="70" y2="84" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="70" y1="84" x2="52" y2="98" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="88" y1="105" x2="110" y2="128" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="110" y1="128" x2="130" y2="155" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="88" y1="105" x2="68" y2="122" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="68" y1="122" x2="52" y2="100" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <circle cx="108" cy="88" r="3.5" fill="#00ffc8"/><circle cx="70" cy="84" r="3.5" fill="#00ffc8"/>
          <circle cx="110" cy="128" r="3.5" fill="#00ffc8"/><circle cx="68" cy="122" r="3.5" fill="#00ffc8"/>
        </g>
        <line x1="155" y1="24" x2="155" y2="156" stroke="#00ffc820" stroke-width="1"/>
        <text x="175" y="92" font-family="'Courier New',monospace" font-size="52" font-weight="900" letter-spacing="-1" fill="url(#tg)" filter="url(#gl)">STICK</text>
        <text x="178" y="128" font-family="'Courier New',monospace" font-size="28" font-weight="400" letter-spacing="10" fill="#ffffff" opacity="0.55">MOTION</text>
        <text x="178" y="152" font-family="'Courier New',monospace" font-size="9" letter-spacing="4" fill="#00ffc8" opacity="0.4">ANIMATE Â· CREATE Â· EXPRESS</text>
        <g stroke="#00ffc8" stroke-width="1.5" opacity="0.3" fill="none">
          <polyline points="8,22 8,8 22,8"/><polyline points="498,8 512,8 512,22"/>
          <polyline points="8,158 8,172 22,172"/><polyline points="498,172 512,172 512,158"/>
        </g>
      </svg>
    </div>

    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-login" onclick="switchTab('login')">ÄÄƒng Nháº­p</button>
      <button class="auth-tab" id="tab-register" onclick="switchTab('register')">ÄÄƒng KÃ½</button>
    </div>

    <div class="field"><label>TÃªn Ä‘Äƒng nháº­p</label><input id="f-user" type="text" onkeydown="if(event.key==='Enter')doAuth()" autocomplete="username"/></div>
    <div class="field"><label>Máº­t kháº©u</label><input id="f-pass" type="password" onkeydown="if(event.key==='Enter')doAuth()" autocomplete="current-password"/></div>
    <div class="field" id="confirm-field" style="display:none"><label>XÃ¡c nháº­n máº­t kháº©u</label><input id="f-confirm" type="password" onkeydown="if(event.key==='Enter')doAuth()"/></div>
    <p class="err" id="auth-err"></p>
    <button class="btn-primary" id="auth-btn" onclick="doAuth()">ÄÄƒng Nháº­p</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <header>
    <div style="display:flex;align-items:center;gap:10px">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 520 180" width="150">
        <defs>
          <linearGradient id="htg" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#00ffc8"/><stop offset="100%" stop-color="#00b8ff"/>
          </linearGradient>
          <filter id="hgl" x="-40%" y="-40%" width="180%" height="180%"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <filter id="hgls" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <g filter="url(#hgls)">
          <circle cx="90" cy="45" r="14" stroke="#00ffc8" stroke-width="3" fill="none"/>
          <line x1="90" y1="59" x2="88" y2="105" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="90" y1="72" x2="108" y2="88" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="108" y1="88" x2="126" y2="72" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="90" y1="72" x2="70" y2="84" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="70" y1="84" x2="52" y2="98" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="88" y1="105" x2="110" y2="128" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="110" y1="128" x2="130" y2="155" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="88" y1="105" x2="68" y2="122" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
          <line x1="68" y1="122" x2="52" y2="100" stroke="#00ffc8" stroke-width="3" stroke-linecap="round"/>
        </g>
        <line x1="155" y1="24" x2="155" y2="156" stroke="#00ffc820" stroke-width="1"/>
        <text x="175" y="92" font-family="'Courier New',monospace" font-size="52" font-weight="900" letter-spacing="-1" fill="url(#htg)" filter="url(#hgl)">STICK</text>
        <text x="178" y="128" font-family="'Courier New',monospace" font-size="28" font-weight="400" letter-spacing="10" fill="#ffffff" opacity="0.5">MOTION</text>
      </svg>
      <span style="font-size:10px;color:#ffffff33;letter-spacing:2px" id="header-user"></span>
    </div>
    <div class="header-nav">
      <button class="nav-btn active" id="nav-editor" onclick="showView('editor')">Soáº¡n Tháº£o</button>
      <button class="nav-btn" id="nav-library" onclick="showView('library')">ThÆ° Viá»‡n <span id="lib-count">(0)</span></button>
      <button class="nav-btn logout" onclick="logout()">ÄÄƒng xuáº¥t</button>
    </div>
  </header>

  <div id="editor">
    <!-- Frame list -->
    <div id="frame-list">
      <div class="fl-label">FRAMES</div>
      <!-- populated by JS -->
    </div>

    <!-- Main canvas area -->
    <div id="canvas-area">
      <div class="canvas-top">
        <input id="anim-name" type="text" value="Hoáº¡t hÃ¬nh má»›i" placeholder="TÃªn hoáº¡t hÃ¬nh..."/>
        <button class="save-btn" id="save-btn" onclick="saveAnim()">LÆ°u</button>
      </div>
      <canvas id="main-canvas" width="400" height="340"></canvas>
      <div class="frame-controls">
        <button class="frame-btn" onclick="prevFrame()">â† TrÆ°á»›c</button>
        <button class="frame-btn" onclick="addFrame()">+ ThÃªm Frame</button>
        <button class="frame-btn" onclick="deleteFrame()">XÃ³a Frame</button>
        <button class="frame-btn" onclick="nextFrame()">Tiáº¿p theo â†’</button>
      </div>
      <p class="hint" id="frame-hint">Frame 1 / 1 â€” KÃ©o cÃ¡c khá»›p Ä‘á»ƒ táº¡o tÆ° tháº¿</p>
    </div>

    <!-- Side panel -->
    <div id="side-panel">
      <p class="sp-label">XEM TRÆ¯á»šC</p>
      <canvas id="preview-canvas" width="218" height="188"></canvas>
      <button class="play-btn" id="play-btn" onclick="togglePlay()">â–¶ PhÃ¡t</button>
      <div>
        <label style="font-size:9px;color:#ffffff44;letter-spacing:2px;display:block;margin-bottom:5px">Tá»C Äá»˜: <span id="fps-label">12</span> FPS</label>
        <input type="range" min="1" max="30" value="12" id="fps-slider" oninput="setFps(this.value)"/>
      </div>
      <div class="sp-divider">
        <p style="font-size:9px;color:#ffffff33;letter-spacing:2px;margin-bottom:8px">POSES NHANH</p>
        <button class="pose-btn" onclick="applyPose('stand')">ğŸ§ Äá»©ng</button>
        <button class="pose-btn" onclick="applyPose('run')">ğŸƒ Cháº¡y</button>
        <button class="pose-btn" onclick="applyPose('kick')">ğŸ¦µ ÄÃ¡</button>
        <button class="pose-btn" onclick="applyPose('wave')">ğŸ™† Váº«y tay</button>
        <button class="pose-btn" onclick="applyPose('jump')">ğŸ¤¸ Nháº£y</button>
      </div>
    </div>
  </div>

  <!-- Library view -->
  <div id="library">
    <h2>ThÆ° Viá»‡n Hoáº¡t HÃ¬nh</h2>
    <div id="lib-content"></div>
  </div>
</div>

<script>
// â”€â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const getUsers = () => { try { return JSON.parse(localStorage.getItem('sm_users')||'{}'); } catch { return {}; } };
const saveUsers = u => localStorage.setItem('sm_users', JSON.stringify(u));
const getSession = () => localStorage.getItem('sm_session');
const setSession = u => localStorage.setItem('sm_session', u);
const clearSession = () => localStorage.removeItem('sm_session');
const getUserAnims = u => { try { return JSON.parse(localStorage.getItem('sm_anims_'+u)||'[]'); } catch { return []; } };
const saveUserAnims = (u, a) => localStorage.setItem('sm_anims_'+u, JSON.stringify(a));

// â”€â”€â”€ FIGURE DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const JOINTS = ['head','neck','spine','hips','lShoulder','rShoulder','lElbow','rElbow','lHand','rHand','lKnee','rKnee','lFoot','rFoot'];
const BONES = [['head','neck'],['neck','spine'],['spine','hips'],['neck','lShoulder'],['neck','rShoulder'],['lShoulder','lElbow'],['lElbow','lHand'],['rShoulder','rElbow'],['rElbow','rHand'],['hips','lKnee'],['lKnee','lFoot'],['hips','rKnee'],['rKnee','rFoot']];

const defaultFig = () => ({
  head:{x:200,y:80}, neck:{x:200,y:110}, spine:{x:200,y:170}, hips:{x:200,y:200},
  lShoulder:{x:170,y:120}, rShoulder:{x:230,y:120},
  lElbow:{x:145,y:155}, rElbow:{x:255,y:155},
  lHand:{x:130,y:190}, rHand:{x:270,y:190},
  lKnee:{x:180,y:255}, rKnee:{x:220,y:255},
  lFoot:{x:170,y:310}, rFoot:{x:230,y:310}
});

const POSES = {
  stand: defaultFig,
  run: () => ({...defaultFig(), lFoot:{x:160,y:340}, rFoot:{x:235,y:280}, lKnee:{x:170,y:290}, rKnee:{x:225,y:240}, lHand:{x:240,y:165}, rHand:{x:145,y:175}, lElbow:{x:225,y:140}, rElbow:{x:160,y:150}}),
  kick: () => ({...defaultFig(), rFoot:{x:290,y:220}, rKnee:{x:265,y:240}, rHand:{x:140,y:150}, lHand:{x:260,y:120}}),
  wave: () => ({...defaultFig(), rHand:{x:280,y:80}, rElbow:{x:265,y:120}, rShoulder:{x:240,y:130}}),
  jump: () => ({...defaultFig(), head:{x:200,y:50}, neck:{x:200,y:80}, spine:{x:200,y:135}, hips:{x:200,y:165}, lShoulder:{x:165,y:88}, rShoulder:{x:235,y:88}, lElbow:{x:135,y:65}, rElbow:{x:265,y:65}, lHand:{x:115,y:45}, rHand:{x:285,y:45}, lKnee:{x:175,y:215}, rKnee:{x:225,y:215}, lFoot:{x:155,y:270}, rFoot:{x:245,y:270}})
};

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = null;
let frames = [defaultFig()];
let currentFrame = 0;
let selectedJoint = null;
let dragging = null;
let playing = false;
let fps = 12;
let playTimer = null;
let playIdx = 0;

// â”€â”€â”€ DRAW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawFigure(ctx, fig, color='#00ffc8', glow=true, sx=1, sy=1) {
  ctx.save();
  if (glow) { ctx.shadowColor = color; ctx.shadowBlur = 12; }
  ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineCap = 'round';
  for (const [a,b] of BONES) {
    ctx.beginPath();
    ctx.moveTo(fig[a].x*sx, fig[a].y*sy);
    ctx.lineTo(fig[b].x*sx, fig[b].y*sy);
    ctx.stroke();
  }
  ctx.beginPath(); ctx.arc(fig.head.x*sx, fig.head.y*sy, 18*Math.min(sx,sy), 0, Math.PI*2); ctx.stroke();
  ctx.restore();
}

function renderEditor() {
  const canvas = document.getElementById('main-canvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // grid
  ctx.strokeStyle='#ffffff08'; ctx.lineWidth=1;
  for(let x=0;x<400;x+=20){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,340);ctx.stroke();}
  for(let y=0;y<340;y+=20){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(400,y);ctx.stroke();}
  // ghost prev
  if(currentFrame>0){
    ctx.globalAlpha=0.2;
    drawFigure(ctx, frames[currentFrame-1], '#ffffff', false);
    ctx.globalAlpha=1;
  }
  drawFigure(ctx, frames[currentFrame]);
  // joints
  const fig = frames[currentFrame];
  for(const j of JOINTS){
    if(j==='head') continue;
    ctx.beginPath(); ctx.arc(fig[j].x, fig[j].y, 6, 0, Math.PI*2);
    ctx.fillStyle = selectedJoint===j ? '#ffcc00' : '#00ffc888';
    ctx.shadowColor = selectedJoint===j ? '#ffcc00' : '#00ffc8';
    ctx.shadowBlur = 8; ctx.fill();
  }
  ctx.shadowBlur=0;
  // hint
  document.getElementById('frame-hint').textContent = `Frame ${currentFrame+1} / ${frames.length} â€” KÃ©o cÃ¡c khá»›p Ä‘á»ƒ táº¡o tÆ° tháº¿`;
  renderFrameList();
}

function renderFrameList() {
  const list = document.getElementById('frame-list');
  // remove old thumbs
  const old = list.querySelectorAll('.frame-thumb');
  old.forEach(e=>e.remove());
  frames.forEach((fig, i) => {
    const div = document.createElement('div');
    div.className = 'frame-thumb' + (i===currentFrame?' active':'');
    div.onclick = () => { currentFrame=i; stopPlay(); renderEditor(); };
    const c = document.createElement('canvas');
    c.width=86; c.height=80; c.style.width='86px';
    const ctx = c.getContext('2d');
    const sx=86/400, sy=80/340;
    ctx.strokeStyle = i===currentFrame ? '#00ffc8' : '#00ffc877';
    ctx.lineWidth=2; ctx.lineCap='round';
    for(const [a,b] of BONES){
      ctx.beginPath();
      ctx.moveTo(fig[a].x*sx, fig[a].y*sy);
      ctx.lineTo(fig[b].x*sx, fig[b].y*sy);
      ctx.stroke();
    }
    ctx.beginPath(); ctx.arc(fig.head.x*sx, fig.head.y*sy, 5, 0, Math.PI*2); ctx.stroke();
    const span = document.createElement('span');
    span.textContent='#'+(i+1);
    div.appendChild(c); div.appendChild(span);
    list.appendChild(div);
  });
}

// â”€â”€â”€ PLAYBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lerp(a,b,t){return a+(b-a)*t;}
function lerpFig(f1,f2,t){
  const out={};
  for(const k of JOINTS) out[k]={x:lerp(f1[k].x,f2[k].x,t), y:lerp(f1[k].y,f2[k].y,t)};
  return out;
}

function togglePlay() {
  playing ? stopPlay() : startPlay();
}

function startPlay() {
  playing=true;
  document.getElementById('play-btn').textContent='â¹ Dá»«ng';
  document.getElementById('play-btn').classList.add('stop');
  playIdx=0;
  tick();
}

function stopPlay() {
  playing=false;
  clearTimeout(playTimer);
  document.getElementById('play-btn').textContent='â–¶ PhÃ¡t';
  document.getElementById('play-btn').classList.remove('stop');
}

function tick() {
  if(!playing) return;
  const canvas = document.getElementById('preview-canvas');
  const ctx = canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#0a0a1a'; ctx.fillRect(0,0,W,H);
  const total=frames.length;
  const f1=frames[playIdx%total];
  const f2=frames[(playIdx+1)%total];
  const sx=W/400, sy=H/340;
  // blur trail
  const ghost=lerpFig(f1,f2,0.5);
  ctx.globalAlpha=0.3;
  drawFigure(ctx,ghost,'#00ffc8',true,sx,sy);
  ctx.globalAlpha=1;
  drawFigure(ctx,f1,'#00ffc8',true,sx,sy);
  playIdx=(playIdx+1)%total;
  playTimer=setTimeout(tick, 1000/fps);
}

// â”€â”€â”€ FRAME OPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addFrame() {
  const copy = JSON.parse(JSON.stringify(frames[currentFrame]));
  frames.splice(currentFrame+1, 0, copy);
  currentFrame++;
  renderEditor();
}

function deleteFrame() {
  if(frames.length===1) return;
  frames.splice(currentFrame,1);
  currentFrame=Math.min(currentFrame, frames.length-1);
  renderEditor();
}

function prevFrame(){currentFrame=Math.max(0,currentFrame-1);stopPlay();renderEditor();}
function nextFrame(){currentFrame=Math.min(frames.length-1,currentFrame+1);stopPlay();renderEditor();}

function applyPose(name) {
  frames[currentFrame] = POSES[name]();
  renderEditor();
}

function setFps(v) {
  fps=+v;
  document.getElementById('fps-label').textContent=v;
}

// â”€â”€â”€ CANVAS DRAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const mc = document.getElementById('main-canvas');

function getCanvasPos(e) {
  const rect = mc.getBoundingClientRect();
  const cx = e.touches ? e.touches[0].clientX : e.clientX;
  const cy = e.touches ? e.touches[0].clientY : e.clientY;
  return {
    x: Math.max(0,Math.min(400,(cx-rect.left)*(400/rect.width))),
    y: Math.max(0,Math.min(340,(cy-rect.top)*(340/rect.height)))
  };
}

mc.addEventListener('mousedown', startDrag);
mc.addEventListener('touchstart', e=>{e.preventDefault();startDrag(e);}, {passive:false});

function startDrag(e) {
  const {x,y} = getCanvasPos(e);
  const fig=frames[currentFrame];
  let closest=null, dist=18;
  for(const j of JOINTS){
    const d=Math.hypot(fig[j].x-x, fig[j].y-y);
    if(d<dist){dist=d;closest=j;}
  }
  if(closest){selectedJoint=closest;dragging=closest;renderEditor();}
}

window.addEventListener('mousemove', moveDrag);
window.addEventListener('touchmove', e=>{e.preventDefault();moveDrag(e);},{passive:false});

function moveDrag(e) {
  if(!dragging) return;
  const {x,y}=getCanvasPos(e);
  frames[currentFrame][dragging]={x,y};
  renderEditor();
}

window.addEventListener('mouseup', ()=>{dragging=null;});
window.addEventListener('touchend', ()=>{dragging=null;});

// â”€â”€â”€ SAVE / LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveAnim() {
  const name = document.getElementById('anim-name').value.trim() || 'Hoáº¡t hÃ¬nh má»›i';
  const anims = getUserAnims(currentUser);
  const idx = anims.findIndex(a=>a.name===name);
  const entry = {name, frames:JSON.parse(JSON.stringify(frames)), fps, savedAt:Date.now()};
  if(idx>=0) anims[idx]=entry; else anims.push(entry);
  saveUserAnims(currentUser, anims);
  const btn=document.getElementById('save-btn');
  btn.textContent='âœ“ ÄÃ£ lÆ°u'; btn.classList.add('saved');
  setTimeout(()=>{btn.textContent='LÆ°u';btn.classList.remove('saved');},2000);
  updateLibCount();
}

// â”€â”€â”€ LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLibrary() {
  const anims = getUserAnims(currentUser);
  const c = document.getElementById('lib-content');
  if(anims.length===0){
    c.innerHTML='<div class="lib-empty"><span style="font-size:44px;opacity:.3">ğŸ¬</span><p style="color:#ffffff33;letter-spacing:2px;font-size:12px">ChÆ°a cÃ³ hoáº¡t hÃ¬nh nÃ o Ä‘Æ°á»£c lÆ°u</p></div>';
    return;
  }
  c.innerHTML='<div class="lib-grid">'+anims.map(a=>`
    <div class="lib-card">
      <div class="lib-card-name">${a.name}</div>
      <div class="lib-card-meta">${a.frames.length} frames Â· ${a.fps} FPS Â· ${new Date(a.savedAt).toLocaleDateString('vi-VN')}</div>
      <div class="lib-card-actions">
        <button class="lib-open" onclick="loadAnim('${encodeURIComponent(a.name)}')">Má»Ÿ</button>
        <button class="lib-del" onclick="deleteAnim('${encodeURIComponent(a.name)}')">ğŸ—‘</button>
      </div>
    </div>
  `).join('')+'</div>';
}

function loadAnim(encodedName) {
  const name=decodeURIComponent(encodedName);
  const anims=getUserAnims(currentUser);
  const a=anims.find(x=>x.name===name);
  if(!a) return;
  frames=JSON.parse(JSON.stringify(a.frames));
  fps=a.fps;
  currentFrame=0;
  document.getElementById('anim-name').value=a.name;
  document.getElementById('fps-slider').value=fps;
  document.getElementById('fps-label').textContent=fps;
  showView('editor');
}

function deleteAnim(encodedName) {
  const name=decodeURIComponent(encodedName);
  const anims=getUserAnims(currentUser).filter(a=>a.name!==name);
  saveUserAnims(currentUser,anims);
  updateLibCount();
  renderLibrary();
}

function updateLibCount() {
  const n=getUserAnims(currentUser).length;
  document.getElementById('lib-count').textContent=`(${n})`;
}

// â”€â”€â”€ VIEW SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showView(v) {
  const isEditor = v==='editor';
  document.getElementById('editor').style.display = isEditor ? 'flex' : 'none';
  document.getElementById('library').classList.toggle('show', !isEditor);
  document.getElementById('nav-editor').classList.toggle('active', isEditor);
  document.getElementById('nav-library').classList.toggle('active', !isEditor);
  if(!isEditor){ stopPlay(); renderLibrary(); }
  else renderEditor();
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let authMode = 'login';

function switchTab(mode) {
  authMode=mode;
  document.getElementById('tab-login').classList.toggle('active', mode==='login');
  document.getElementById('tab-register').classList.toggle('active', mode==='register');
  document.getElementById('confirm-field').style.display = mode==='register' ? 'block' : 'none';
  document.getElementById('auth-btn').textContent = mode==='login' ? 'ÄÄƒng Nháº­p' : 'Táº¡o TÃ i Khoáº£n';
  document.getElementById('auth-err').textContent='';
}

function doAuth() {
  const u=document.getElementById('f-user').value.trim();
  const p=document.getElementById('f-pass').value;
  const c=document.getElementById('f-confirm').value;
  const err=document.getElementById('auth-err');
  err.textContent='';
  const users=getUsers();
  if(authMode==='login'){
    if(!users[u]||users[u]!==p){err.textContent='Sai tÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u';return;}
    loginSuccess(u);
  } else {
    if(!u||!p){err.textContent='Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin';return;}
    if(p!==c){err.textContent='Máº­t kháº©u khÃ´ng khá»›p';return;}
    if(users[u]){err.textContent='TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i';return;}
    users[u]=p; saveUsers(users); loginSuccess(u);
  }
}

function loginSuccess(u) {
  currentUser=u;
  setSession(u);
  document.getElementById('auth').style.display='none';
  document.getElementById('app').classList.add('show');
  document.getElementById('header-user').textContent='by '+u;
  updateLibCount();
  renderEditor();
}

function logout() {
  clearSession(); currentUser=null; stopPlay();
  frames=[defaultFig()]; currentFrame=0;
  document.getElementById('app').classList.remove('show');
  document.getElementById('auth').style.display='flex';
  document.getElementById('f-user').value='';
  document.getElementById('f-pass').value='';
  document.getElementById('auth-err').textContent='';
}

// â”€â”€â”€ BG CANVAS (auth) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function bgAnim(){
  const c=document.getElementById('bg-canvas');
  const ctx=c.getContext('2d');
  c.width=window.innerWidth; c.height=window.innerHeight;
  let t=0, raf;
  const fig=defaultFig();
  function frame(){
    ctx.clearRect(0,0,c.width,c.height);
    t+=0.025;
    const w=JSON.parse(JSON.stringify(fig));
    w.lFoot.y=310+Math.sin(t*2)*15;
    w.rFoot.y=310-Math.sin(t*2)*15;
    w.lHand.y=190+Math.sin(t*2)*18;
    w.rHand.y=190-Math.sin(t*2)*18;
    w.head.x=200+Math.sin(t)*5;
    for(let i=0;i<6;i++){
      const g=JSON.parse(JSON.stringify(w));
      const dx=(i-2.5)*170;
      for(const k of JOINTS){g[k].x+=dx+c.width/2-200;g[k].y+=c.height/2-195;}
      ctx.globalAlpha=0.04+i*0.012;
      ctx.strokeStyle='#00ffc8'; ctx.lineWidth=2; ctx.lineCap='round';
      ctx.shadowColor='#00ffc8'; ctx.shadowBlur=6;
      for(const [a,b] of BONES){ctx.beginPath();ctx.moveTo(g[a].x,g[a].y);ctx.lineTo(g[b].x,g[b].y);ctx.stroke();}
      ctx.beginPath();ctx.arc(g.head.x,g.head.y,18,0,Math.PI*2);ctx.stroke();
    }
    ctx.globalAlpha=1; ctx.shadowBlur=0;
    raf=requestAnimationFrame(frame);
  }
  frame();
  window.addEventListener('resize',()=>{c.width=window.innerWidth;c.height=window.innerHeight;});
})();

// â”€â”€â”€ AUTO LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const saved=getSession();
if(saved){
  const users=getUsers();
  if(users[saved]) loginSuccess(saved);
}
</script>
</body>
</html>
